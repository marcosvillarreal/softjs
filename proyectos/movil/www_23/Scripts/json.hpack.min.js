/** json.hpack
 * @description JSON Homogeneous Collection Packer
 * @version     1.0.1
 * @author      Andrea Giammarchi
 * @license     Mit Style License
 * @project     http://github.com/WebReflection/json.hpack/tree/master
 * @blog        http://webreflection.blogspot.com/
 */(function(cache){(this.JSON||(JSON={})).hpack=function(collection,compression){if(3<compression){var i=JSON.hbest(collection),result=cache[i];cache=[]}else{var indexOf=Array.prototype.indexOf||function(v){for(var l=this.length,i=0;i<l;++i){if(this[i]===v){return i}}return -1},header=[],result=[header],first=collection[0],index=0,k=0,len;for(var key in first){header[index++]=key}len=index;index=0;for(var length=collection.length,i=0;i<length;++i){for(var item=collection[i],row=[],j=0;j<len;++j){row[j]=item[header[j]]}result[++index]=row}++index;if(0<compression){for(row=result[1],j=0;j<len;++j){if(typeof row[j]!="number"){header[j]=[header[j],first=[]];first.indexOf=indexOf;for(i=1;i<index;++i){var value=result[i][j],l=first.indexOf(value);result[i][j]=l<0?first.push(value)-1:l}}}}if(2<compression){for(j=0;j<len;++j){if(header[j] instanceof Array){for(row=header[j][1],value=[],first=[],k=0,i=1;i<index;++i){value[k]=row[first[k]=result[i][j]];++k}if(JSON.stringify(value).length<JSON.stringify(first.concat(row)).length){for(k=0,i=1;i<index;++i){result[i][j]=value[k];++k}header[j]=header[j][0]}}}}else{if(1<compression){length-=Math.floor(length/2);for(j=0;j<len;++j){if(header[j] instanceof Array){if(length<(first=header[j][1]).length){for(i=1;i<index;++i){var value=result[i][j];result[i][j]=first[value]}header[j]=header[j][0]}}}}}if(0<compression){for(j=0;j<len;++j){if(header[j] instanceof Array){header.splice(j,1,header[j][0],header[j][1]);++len;++j}}}}return result};JSON.hunpack=function(collection){for(var result=[],keys=[],header=collection[0],len=header.length,length=collection.length,index=-1,k=-1,i=0,l=0,j,row;i<len;++i){keys[++k]=header[i];if(typeof header[i+1]=="object"){++i;for(j=1;j<length;++j){row=collection[j];row[l]=header[i][row[l]]}}++l}for(i=0,len=keys.length;i<len;++i){keys[i]='o["'.concat(keys[i].replace('"',"\\x22"),'"]=a[',i,"];")}var anonymous=Function("o,a",keys.join("")+"return o;");for(j=1;j<length;++j){result[++index]=anonymous({},collection[j])}return result};JSON.hclone=function(collection){for(var clone=[],i=0,length=collection.length;i<length;++i){clone[i]=collection[i].slice(0)}return clone};JSON.hbest=function(collection){for(var i=0,j=0,len=0,length=0;i<4;++i){cache[i]=JSON.hpack(collection,i);len=JSON.stringify(cache[i]).length;if(length===0){length=len}else{if(len<length){length=len;j=i}}}return j}})([]);